// ============================================
// CONFIGURATION DES LANGUES
// ============================================
var translations = {
    fr: {
        // Header
        headerText: "Cr√©ez et partagez vos v≈ìux de No√´l personnalis√©s",
        timerTitle: "Temps restant jusqu'√† No√´l",
        days: "Jours",
        hours: "Heures",
        minutes: "Minutes",
        seconds: "Secondes",
        
        // Step 1 - Cr√©ation
        step1Title: "Cr√©ez vos v≈ìux",
        senderLabel: "Votre pr√©nom :",
        wishTypeLabel: "Type de v≈ìux :",
        customOption: "Je cr√©e mes propres v≈ìux",
        predefinedOption: "Je choisis parmi des v≈ìux pr√©d√©finis",
        customWishLabel: "Vos v≈ìux de No√´l :",
        selectWishLabel: "S√©lectionnez vos v≈ìux :",
        createButton: "Cr√©er et partager",
        
        // Step 2 - Pr√©visualisation exp√©diteur
        step2Title: "Votre v≈ìu est pr√™t !",
        christmasTitle: "Joyeux No√´l !",
        forText: "Pour :",
        fromText: "De la part de :",
        downloadText: "T√©l√©charger en image",
        facebookText: "Partager sur Facebook",
        twitterText: "Partager sur Twitter",
        whatsappText: "Partager sur WhatsApp",
        modifyText: "Modifier",
        newWishText: "Nouveau v≈ìu",
        
        // Step 3 - Destinataire entre son nom
        step3Title: "Bonjour !",
        greetingText: "Quelqu'un a pens√© √† vous pour No√´l !",
        instructionText: "Entrez votre pr√©nom pour d√©couvrir le message",
        recipientLabel: "Votre pr√©nom :",
        viewButton: "Voir le message",
        
        // Step 4 - Affichage destinataire
        step4Title: "V≈ìux de No√´l pour vous",
        finalForText: "Pour :",
        finalFromText: "De la part de :",
        downloadFinalText: "T√©l√©charger en image",
        facebookFinalText: "Partager",
        twitterFinalText: "Partager",
        whatsappFinalText: "Partager",
        responseText: "R√©pondre avec vos v≈ìux",
        
        // Footer
        madeWith: "Fait avec",
        forChristmas: "pour No√´l",
        shareMagic: "Partagez la magie de No√´l avec vos proches !",
        
        // V≈ìux pr√©d√©finis en fran√ßais
        wishes: [
            {
                title: "V≈ìux Classiques",
                content: "Je te souhaite un Joyeux No√´l rempli de bonheur, d'amour et de paix. Que cette p√©riode festive t'apporte joie et r√©confort aupr√®s de tes proches."
            },
            {
                title: "V≈ìux Famille",
                content: "Pour ce No√´l, je souhaite √† ta famille des moments chaleureux, des rires partag√©s et une complicit√© renforc√©e. Que la magie de No√´l illumine votre foyer."
            },
            {
                title: "V≈ìux Amiti√©",
                content: "En cette belle p√©riode de No√´l, je pense √† toi et √† notre amiti√© pr√©cieuse. Je te souhaite des f√™tes rayonnantes et une nouvelle ann√©e merveilleuse."
            }
        ]
    },
    ee: { // Ewe (Togo)
        // Header
        headerText: "W√≤a…ñe …ñe edzi na wo ∆íe dzidz…îkp…îkp…î ∆íe Kristmas ∆íe ∆íu∆ío∆ío",
        timerTitle: "Esi w√≤az√£ va le Kristmas ≈ãu",
        days: "≈äkeke",
        hours: "Ga∆ío∆ío",
        minutes: "A∆íli∆íli",
        seconds: "Sekend",
        
        // Step 1 - Cr√©ation
        step1Title: "∆âe wo ∆íe dzidz…îkp…îkp…î ∆íe edzi",
        senderLabel: "Wo ∆íe ≈ãk…î :",
        wishTypeLabel: "Dzidz…îkp…îkp…î ∆íe akpa :",
        customOption: "Melia≈ãut…î nu wo ∆íe dzidz…îkp…îkp…î",
        predefinedOption: "Mets…î …ñe dzidz…îkp…îkp…î siwo woz√£na ∆íe dome",
        customWishLabel: "Wo ∆íe Kristmas ∆íe dzidz…îkp…îkp…î :",
        selectWishLabel: "Tiatia wo ∆íe dzidz…îkp…îkp…î :",
        createButton: "∆âe edzi eye ∆ëo",
        
        // Step 2 - Pr√©visualisation exp√©diteur
        step2Title: "Wo ∆íe dzidz…îkp…îkp…î wo…ño!",
        christmasTitle: "Kristmas y…î…îd…î!",
        forText: "Ne :",
        fromText: "Tso :",
        downloadText: "∆âa…ñewo…£i …ñe nufiala me",
        facebookText: "∆ëo …ñe Facebook ≈ãu",
        twitterText: "∆ëo …ñe Twitter ≈ãu",
        whatsappText: "∆ëo …ñe WhatsApp ≈ãu",
        modifyText: "T…îtr…î",
        newWishText: "Dzidz…îkp…îkp…î yeyeye",
        
        // Step 3 - Destinataire entre son nom
        step3Title: "≈ädi!",
        greetingText: "Ame …ñe susu …ñe w√≤ ≈ãu ne Kristmas!",
        instructionText: "∆âe wo ∆íe ≈ãk…î …ñe eme ne w√≤adi be w√≤akp…î nya",
        recipientLabel: "Wo ∆íe ≈ãk…î :",
        viewButton: "Kp…î nya",
        
        // Step 4 - Affichage destinataire
        step4Title: "Kristmas ∆íe dzidz…îkp…îkp…î ne w√≤",
        finalForText: "Ne :",
        finalFromText: "Tso :",
        downloadFinalText: "∆âa…ñewo…£i …ñe nufiala me",
        facebookFinalText: "∆ëo",
        twitterFinalText: "∆ëo",
        whatsappFinalText: "∆ëo",
        responseText: "∆âe wo∆ío∆ío ∆íe nya …ñe e≈ãu",
        
        // Footer
        madeWith: "W…îe …ñe",
        forChristmas: "ne Kristmas",
        shareMagic: "∆ëo …ñe Kristmas ∆íe dzidz…î ∆íe nudzadzra …ñe wo ∆íe amewo ≈ãu!",
        
        // V≈ìux pr√©d√©finis en Ewe
        wishes: [
            {
                title: "Dzidz…îkp…îkp…î vovovowo",
                content: "Melia ≈ãu na w√≤ be Kristmas y…î…îd…î …ñe dzidz…î, l…îl…îÃÉ kple a…ña≈ãudzedze ∆íe dedienu. Ne …£eyi…£i sia …ña dzidz…î kple d…îmenyonyo …ñe w√≤ ≈ãu le wo∆íome."
            },
            {
                title: "∆ëome∆ío ∆íe dzidz…îkp…îkp…î",
                content: "Ne Kristmas sia, melia ≈ãu na w√≤∆íome∆ío be w√≤a∆ío d…îmenyonyo, a ãatsotso siwo woa∆ío ∆íu …ñe e≈ãu kple …ñokui si woa…ñe …ñe edzi. Ne Kristmas ∆íe dzidz…î …ña …£e…ñi…ñi …ñe a∆íe."
            },
            {
                title: "…ñokuiw…î∆íe ∆íe dzidz…îkp…îkp…î",
                content: "Ne Kristmas ∆íe …£eyi…£i sia, me…ñe susu …ñe w√≤ ≈ãu kple m√≠a∆íe …ñokui si mele ≈ãu vevie. Melia ≈ãu na w√≤ be dzidz…î∆ío∆íowo …ñe …£eyi…£i sia ≈ãu kple ∆íe yeye si mele ≈ãu vevie."
            }
        ]
    }
};

// Donn√©es initiales des v≈ìux pr√©d√©finis (fran√ßais par d√©faut)
var predefinedWishes = translations.fr.wishes;

// V≈ìux personnalis√©s ajout√©s par les utilisateurs
var customWishes = [];

// √âtat de la langue actuelle
var currentLang = 'fr';

// Donn√©es du v≈ìu actuel
var currentWishData = null;

// Variable pour le timer
var timerInterval;

// ============================================
// √âL√âMENTS DOM
// ============================================
var step1 = document.getElementById('step1');
var step2 = document.getElementById('step2');
var step3 = document.getElementById('step3');
var step4 = document.getElementById('step4');

var senderNameInput = document.getElementById('sender-name');
var wishTypeSelect = document.getElementById('wish-type');
var customWishSection = document.getElementById('custom-wish-section');
var predefinedWishesSection = document.getElementById('predefined-wishes-section');
var customWishTextarea = document.getElementById('custom-wish');
var wishesGrid = document.getElementById('wishes-grid');
var recipientNameInput = document.getElementById('recipient-name');

// Variables d'√©tat
var selectedWish = "";
var selectedPredefinedWishIndex = -1;

// ============================================
// INITIALISATION
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    // G√©n√©rer les flocons de neige
    createSnowflakes();
    
    // Initialiser le timer de No√´l
    initChristmasTimer();
    
    // G√©n√©rer les v≈ìux pr√©d√©finis
    generatePredefinedWishes();
    
    // Configurer les √©couteurs d'√©v√©nements
    setupEventListeners();
    
    // Mettre √† jour l'affichage bas√© sur le type de v≈ìux s√©lectionn√©
    updateWishTypeDisplay();
    
    // V√©rifier l'URL pour voir si on est un destinataire
    checkIfRecipient();
    
    // Charger les v≈ìux personnalis√©s sauvegard√©s
    loadCustomWishes();
    
    // Initialiser avec la langue fran√ßaise
    switchLanguage('fr');
});

// ============================================
// V√âRIFIER SI L'UTILISATEUR EST UN DESTINATAIRE
// ============================================
function checkIfRecipient() {
    var urlParams = new URLSearchParams(window.location.search);
    var wishId = urlParams.get('wish');
    var dataEncoded = urlParams.get('data');
    
    if (wishId && dataEncoded) {
        // On est un destinataire
        try {
            var wishData = JSON.parse(atob(dataEncoded));
            currentWishData = wishData;
            currentLang = wishData.l || 'fr';
            
            // Passer directement √† l'√©tape 3 (destinataire entre son nom)
            goToStep3AsRecipient();
            
            // Mettre √† jour la langue
            switchLanguage(currentLang);
            
            // Mettre √† jour l'affichage avec les donn√©es du v≈ìu
            if (currentWishData) {
                document.getElementById('final-sender').textContent = currentWishData.s;
                document.getElementById('final-wish').textContent = currentWishData.m;
            }
        } catch (e) {
            console.error('Erreur de d√©codage des donn√©es:', e);
            // En cas d'erreur, afficher un message
            alert(currentLang === 'fr' 
                ? "D√©sol√©, le lien semble incorrect. Veuillez v√©rifier avec la personne qui vous l'a envoy√©."
                : "Babia, l…îÃÉ sia mele e≈ãu o. Taflatse dzesii …ñe ame si wofoa na w√≤ ≈ãu.");
        }
    }
}

// ============================================
// TIMER DE NO√ãL - CORRIG√â
// ============================================
function initChristmasTimer() {
    // Arr√™ter le timer existant s'il y en a un
    if (timerInterval) {
        clearInterval(timerInterval);
    }
    
    // Mettre √† jour imm√©diatement
    updateChristmasTimer();
    
    // D√©marrer le timer
    timerInterval = setInterval(updateChristmasTimer, 1000);
}

function updateChristmasTimer() {
    var now = new Date();
    var currentYear = now.getFullYear();
    
    // Date de No√´l (25 d√©cembre de l'ann√©e en cours)
    var christmas = new Date(currentYear, 11, 25); // 11 = d√©cembre
    
    // Si No√´l est d√©j√† pass√© cette ann√©e, prendre l'ann√©e prochaine
    if (now > christmas) {
        christmas = new Date(currentYear + 1, 11, 25);
    }
    
    var diff = christmas - now;
    
    var days = Math.floor(diff / (1000 * 60 * 60 * 24));
    var hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    var minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    var seconds = Math.floor((diff % (1000 * 60)) / 1000);
    
    // Mettre √† jour l'affichage
    document.getElementById('days').textContent = days.toString().padStart(2, '0');
    document.getElementById('hours').textContent = hours.toString().padStart(2, '0');
    document.getElementById('minutes').textContent = minutes.toString().padStart(2, '0');
    document.getElementById('seconds').textContent = seconds.toString().padStart(2, '0');
}

// ============================================
// GESTION DES LANGUES - CORRIG√â
// ============================================
function switchLanguage(lang) {
    currentLang = lang;
    var t = translations[lang];
    
    // Mettre √† jour les textes
    document.getElementById('header-text').textContent = t.headerText;
    document.getElementById('timer-title').textContent = t.timerTitle;
    document.getElementById('days-label').textContent = t.days;
    document.getElementById('hours-label').textContent = t.hours;
    document.getElementById('minutes-label').textContent = t.minutes;
    document.getElementById('seconds-label').textContent = t.seconds;
    
    // √âtape 1
    document.getElementById('step1-title').textContent = t.step1Title;
    document.getElementById('sender-label').textContent = t.senderLabel;
    document.getElementById('wish-type-label').textContent = t.wishTypeLabel;
    document.getElementById('custom-option').textContent = t.customOption;
    document.getElementById('predefined-option').textContent = t.predefinedOption;
    document.getElementById('custom-wish-label').textContent = t.customWishLabel;
    document.getElementById('select-wish-label').textContent = t.selectWishLabel;
    document.getElementById('create-button').textContent = t.createButton;
    
    // √âtape 2
    document.getElementById('step2-title').textContent = t.step2Title;
    document.getElementById('christmas-title').textContent = t.christmasTitle;
    document.getElementById('for-text').textContent = t.forText;
    document.getElementById('from-text').textContent = t.fromText;
    document.getElementById('download-text').textContent = t.downloadText;
    document.getElementById('facebook-text').textContent = t.facebookText;
    document.getElementById('twitter-text').textContent = t.twitterText;
    document.getElementById('whatsapp-text').textContent = t.whatsappText;
    document.getElementById('modify-text').textContent = t.modifyText;
    document.getElementById('new-wish-text').textContent = t.newWishText;
    
    // √âtape 3
    document.getElementById('step3-title').textContent = t.step3Title;
    document.getElementById('greeting-text').textContent = t.greetingText;
    document.getElementById('instruction-text').textContent = t.instructionText;
    document.getElementById('recipient-label').textContent = t.recipientLabel;
    document.getElementById('view-button').textContent = t.viewButton;
    
    // √âtape 4
    document.getElementById('step4-title').textContent = t.step4Title;
    document.getElementById('final-christmas-title').textContent = t.christmasTitle;
    document.getElementById('final-for-text').textContent = t.finalForText;
    document.getElementById('final-from-text').textContent = t.finalFromText;
    document.getElementById('download-final-text').textContent = t.downloadFinalText;
    document.getElementById('response-text').textContent = t.responseText;
    
    // Footer
    document.getElementById('made-with').textContent = t.madeWith;
    document.getElementById('for-christmas').textContent = t.forChristmas;
    document.getElementById('share-magic').textContent = t.shareMagic;
    
    // Mettre √† jour la langue affich√©e
    document.getElementById('current-lang').textContent = lang.toUpperCase();
    
    // Mettre √† jour les v≈ìux pr√©d√©finis
    predefinedWishes = t.wishes;
    generatePredefinedWishes();
    
    // Mettre √† jour l'affichage si un v≈ìu est d√©j√† cr√©√©
    if (currentWishData) {
        updateWishDisplay();
    }
}

// ============================================
// CR√âATION DE FLOCONS DE NEIGE
// ============================================
function createSnowflakes() {
    var snowflakeContainer = document.body;
    var snowflakeCount = 50;
    
    for (var i = 0; i < snowflakeCount; i++) {
        var snowflake = document.createElement('div');
        snowflake.classList.add('snowflake');
        
        // Taille al√©atoire
        var size = Math.random() * 10 + 5;
        snowflake.style.width = size + 'px';
        snowflake.style.height = size + 'px';
        
        // Position de d√©part al√©atoire
        snowflake.style.left = Math.random() * 100 + 'vw';
        snowflake.style.top = -size + 'px';
        
        // Opacit√© al√©atoire
        snowflake.style.opacity = Math.random() * 0.7 + 0.3;
        
        // Dur√©e d'animation al√©atoire
        var duration = Math.random() * 10 + 10;
        snowflake.style.animation = 'fall ' + duration + 's linear infinite';
        
        // D√©lai d'animation al√©atoire
        snowflake.style.animationDelay = Math.random() * 5 + 's';
        
        snowflakeContainer.appendChild(snowflake);
    }
}

// ============================================
// G√âN√âRATION DES V≈íUX PR√âD√âFINIS
// ============================================
function generatePredefinedWishes() {
    wishesGrid.innerHTML = '';
    
    // Combiner v≈ìux pr√©d√©finis et personnalis√©s
    var allWishes = predefinedWishes.concat(customWishes);
    
    allWishes.forEach(function(wish, index) {
        var wishElement = document.createElement('div');
        wishElement.classList.add('wish-option');
        if (index === 0) {
            wishElement.classList.add('selected');
            selectedPredefinedWishIndex = 0;
            selectedWish = wish.content;
        }
        
        wishElement.innerHTML = '<h4>' + wish.title + '</h4>' +
            '<p>' + wish.content.substring(0, 80) + '...</p>';
        
        wishElement.addEventListener('click', function() {
            // Retirer la s√©lection de toutes les options
            document.querySelectorAll('.wish-option').forEach(function(option) {
                option.classList.remove('selected');
            });
            
            // Ajouter la s√©lection √† l'option cliqu√©e
            wishElement.classList.add('selected');
            selectedPredefinedWishIndex = index;
            selectedWish = wish.content;
        });
        
        wishesGrid.appendChild(wishElement);
    });
}

// ============================================
// AJOUTER UN V≈íU PERSONNALIS√â - CORRIG√â
// ============================================
function addCustomWish(senderName, content) {
    // CORRECTION : Utiliser un titre g√©n√©rique pour les v≈ìux personnalis√©s
    var title = currentLang === 'fr' ? 
        'V≈ìu personnalis√©' : 
        'Dzidz…îkp…îkp…î si woa…ñe …ñe edzi';
    
    var newWish = {
        title: title,
        content: content,
        sender: senderName,
        date: new Date().toISOString()
    };
    
    customWishes.push(newWish);
    
    // Sauvegarder dans localStorage
    saveCustomWishes();
    
    // Reg√©n√©rer la liste
    generatePredefinedWishes();
    
    return newWish;
}

// ============================================
// SAUVEGARDE DES V≈íUX PERSONNALIS√âS
// ============================================
function saveCustomWishes() {
    try {
        localStorage.setItem('noelmagique_custom_wishes', JSON.stringify(customWishes));
    } catch (e) {
        console.error('Erreur de sauvegarde:', e);
    }
}

function loadCustomWishes() {
    try {
        var saved = localStorage.getItem('noelmagique_custom_wishes');
        if (saved) {
            customWishes = JSON.parse(saved);
        }
    } catch (e) {
        console.error('Erreur de chargement:', e);
    }
}

// ============================================
// CONFIGURATION DES √âCOUTEURS D'√âV√âNEMENTS
// ============================================
function setupEventListeners() {
    // Changement du type de v≈ìux
    wishTypeSelect.addEventListener('change', updateWishTypeDisplay);
    
    // Boutons de navigation
    document.getElementById('create-wish').addEventListener('click', createWish);
    document.getElementById('back-to-step1').addEventListener('click', goToStep1);
    document.getElementById('new-wish').addEventListener('click', resetForm);
    document.getElementById('view-wish').addEventListener('click', viewWishAsRecipient);
    document.getElementById('create-response').addEventListener('click', createResponse);
    
    // Boutons de t√©l√©chargement PNG
    document.getElementById('download-png').addEventListener('click', function() {
        downloadAsPNG('wish-card-preview');
    });
    document.getElementById('download-png-final').addEventListener('click', function() {
        downloadAsPNG('wish-card-final');
    });
    
    // Boutons de partage
    document.getElementById('share-facebook').addEventListener('click', shareOnFacebook);
    document.getElementById('share-twitter').addEventListener('click', shareOnTwitter);
    document.getElementById('share-whatsapp').addEventListener('click', shareOnWhatsApp);
    
    // Bouton de changement de langue
    document.getElementById('lang-toggle').addEventListener('click', toggleLanguage);
    
    // Mise √† jour en temps r√©el des v≈ìux personnalis√©s
    customWishTextarea.addEventListener('input', function() {
        selectedWish = this.value;
    });
    
    // Initialiser avec le premier v≈ìu pr√©d√©fini s√©lectionn√©
    if (predefinedWishes && predefinedWishes.length > 0) {
        selectedWish = predefinedWishes[0].content;
        selectedPredefinedWishIndex = 0;
    }
}

// ============================================
// CHANGEMENT DE LANGUE
// ============================================
function toggleLanguage() {
    var newLang = currentLang === 'fr' ? 'ee' : 'fr';
    switchLanguage(newLang);
    
    // Red√©marrer le timer pour mettre √† jour les labels
    initChristmasTimer();
}

// ============================================
// MISE √Ä JOUR DE L'AFFICHAGE
// ============================================
function updateWishTypeDisplay() {
    if (wishTypeSelect.value === 'custom') {
        customWishSection.style.display = 'block';
        predefinedWishesSection.style.display = 'none';
        selectedWish = customWishTextarea.value;
    } else {
        customWishSection.style.display = 'none';
        predefinedWishesSection.style.display = 'block';
        if (selectedPredefinedWishIndex >= 0 && predefinedWishes[selectedPredefinedWishIndex]) {
            selectedWish = predefinedWishes[selectedPredefinedWishIndex].content;
        } else if (predefinedWishes.length > 0) {
            selectedWish = predefinedWishes[0].content;
            selectedPredefinedWishIndex = 0;
        }
    }
}

// ============================================
// CR√âATION D'UN V≈íU - CORRIG√â
// ============================================
function createWish() {
    // Validation du nom
    if (!senderNameInput.value.trim()) {
        alert(currentLang === 'fr' ? "Veuillez entrer votre pr√©nom" : "Taflatse ∆âe wo ∆íe ≈ãk…î …ñe eme");
        senderNameInput.focus();
        return;
    }
    
    // Validation selon le type de v≈ìux
    if (wishTypeSelect.value === 'custom') {
        // V≈ìux personnalis√©s
        if (!customWishTextarea.value.trim()) {
            alert(currentLang === 'fr' ? "Veuillez entrer vos v≈ìux" : "Taflatse ∆âe wo ∆íe dzidz…îkp…îkp…î …ñe eme");
            customWishTextarea.focus();
            return;
        }
        selectedWish = customWishTextarea.value.trim();
    } else {
        // V≈ìux pr√©d√©finis
        if (selectedPredefinedWishIndex < 0 || !predefinedWishes[selectedPredefinedWishIndex]) {
            alert(currentLang === 'fr' ? "Veuillez s√©lectionner un v≈ìu pr√©d√©fini" : "Taflatse Tiatia dzidz…îkp…îkp…î …ñeka si woz√£na");
            return;
        }
        selectedWish = predefinedWishes[selectedPredefinedWishIndex].content;
    }
    
    // Cr√©er l'objet v≈ìu
    currentWishData = {
        s: senderNameInput.value.trim(), // Exp√©diteur
        m: selectedWish, // Message
        l: currentLang, // Langue
        id: generateWishId()
    };
    
    // Si c'est un v≈ìu personnalis√©, l'ajouter √† la liste
    if (wishTypeSelect.value === 'custom') {
        addCustomWish(senderNameInput.value.trim(), selectedWish);
    }
    
    // Mettre √† jour l'affichage de pr√©visualisation
    updatePreviewDisplay();
    
    // Passer √† l'√©tape 2 (pr√©visualisation)
    goToStep2();
}

// ============================================
// MISE √Ä JOUR DE L'AFFICHAGE DE PR√âVISUALISATION
// ============================================
function updatePreviewDisplay() {
    if (!currentWishData) return;
    
    document.getElementById('preview-sender').textContent = currentWishData.s;
    document.getElementById('preview-wish').textContent = currentWishData.m;
    document.getElementById('preview-recipient').textContent = currentLang === 'fr' ? "votre destinataire" : "wo∆íe ame…ñela";
}

// ============================================
// MISE √Ä JOUR DE L'AFFICHAGE FINAL (DESTINATAIRE)
// ============================================
function updateFinalDisplay(recipientName) {
    if (!currentWishData) return;
    
    document.getElementById('final-sender').textContent = currentWishData.s;
    document.getElementById('final-wish').textContent = currentWishData.m;
    document.getElementById('final-recipient').textContent = recipientName;
}

// ============================================
// G√âN√âRATION D'ID UNIQUE
// ============================================
function generateWishId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

// ============================================
// NAVIGATION ENTRE LES √âTAPES
// ============================================
function goToStep1() {
    step1.classList.add('active');
    step2.classList.remove('active');
    step3.classList.remove('active');
    step4.classList.remove('active');
}

function goToStep2() {
    step1.classList.remove('active');
    step2.classList.add('active');
    step3.classList.remove('active');
    step4.classList.remove('active');
}

function goToStep3AsRecipient() {
    step1.classList.remove('active');
    step2.classList.remove('active');
    step3.classList.add('active');
    step4.classList.remove('active');
}

function goToStep4() {
    step1.classList.remove('active');
    step2.classList.remove('active');
    step3.classList.remove('active');
    step4.classList.add('active');
}

// ============================================
// VUE DU DESTINATAIRE
// ============================================
function viewWishAsRecipient() {
    // Validation
    if (!recipientNameInput.value.trim()) {
        alert(currentLang === 'fr' ? "Veuillez entrer votre pr√©nom" : "Taflatse ∆âe wo ∆íe ≈ãk…î …ñe eme");
        recipientNameInput.focus();
        return;
    }
    
    // Mettre √† jour l'affichage avec le nom du destinataire
    updateFinalDisplay(recipientNameInput.value.trim());
    
    // Passer √† l'√©tape 4 (affichage du message)
    goToStep4();
}

// ============================================
// CR√âER UNE R√âPONSE
// ============================================
function createResponse() {
    // R√©initialiser et retourner √† l'√©tape 1
    resetForm();
    
    // Pr√©-remplir le nom du destinataire avec l'exp√©diteur original
    if (currentWishData && currentWishData.s) {
        senderNameInput.value = recipientNameInput.value.trim();
        customWishTextarea.value = currentLang === 'fr' 
            ? 'Cher(e) ' + currentWishData.s + ',\n\nMerci pour tes beaux v≈ìux de No√´l ! Je te souhaite √©galement un joyeux No√´l rempli de bonheur et une merveilleuse ann√©e 2024.\n\nAvec toute mon amiti√©.'
            : 'Nya≈ãut…î ' + currentWishData.s + ',\n\nAkpe na wo∆íe dzidz…îkp…îkp…î ∆íe Kristmas siwo mele ≈ãu vevie! Melia ≈ãu na w√≤ be Kristmas y…î…îd…î …ñe dzidz…î kple ∆íe 2024 si mele ≈ãu vevie.\n\n…ñe m√≠a∆íe …ñokui kat√£.';
    }
}

// ============================================
// T√âL√âCHARGEMENT EN PNG
// ============================================
function downloadAsPNG(cardId) {
    var card = document.getElementById(cardId);
    
    html2canvas(card, {
        backgroundColor: null,
        scale: 2, // Meilleure qualit√©
        useCORS: true,
        logging: false
    }).then(function(canvas) {
        // Cr√©er un lien de t√©l√©chargement
        var link = document.createElement('a');
        var recipientName = cardId === 'wish-card-final' 
            ? document.getElementById('final-recipient').textContent
            : 'voeux-noel';
        
        link.download = 'voeux-noel-' + recipientName + '.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
    }).catch(function(error) {
        console.error('Erreur lors de la g√©n√©ration de l\'image:', error);
        alert(currentLang === 'fr' 
            ? "D√©sol√©, une erreur est survenue lors de la g√©n√©ration de l'image."
            : "Babia, v…îÃÉ …ñeka de ≈ãu ne woaz√£ nufiala ∆íe agbal·∫Ωa…ñe≈ãu ≈ãu.");
    });
}

// ============================================
// FONCTIONS DE PARTAGE
// ============================================
function getWishShareUrl() {
    if (!currentWishData) {
        return window.location.href;
    }
    
    // Cr√©er une version simplifi√©e des donn√©es pour l'URL
    var shareData = {
        s: currentWishData.s, // Exp√©diteur
        m: currentWishData.m, // Message
        l: currentWishData.l // Langue
    };
    
    // Encoder en Base64 pour l'URL
    var dataEncoded = btoa(JSON.stringify(shareData));
    
    // Construire l'URL de partage
    var baseUrl = window.location.origin + window.location.pathname;
    return baseUrl + '?wish=' + currentWishData.id + '&data=' + encodeURIComponent(dataEncoded);
}

function shareOnFacebook(e) {
    e.preventDefault();
    
    if (!currentWishData) {
        alert(currentLang === 'fr' 
            ? "Veuillez d'abord cr√©er un v≈ìu."
            : "Taflatse ∆âe dzidz…îkp…îkp…î …ñeka ∆íe edzi va …ño.");
        return;
    }
    
    var shareUrl = getWishShareUrl();
    var shareText = '';
    
    if (currentLang === 'fr') {
        shareText = 'üéÑ ' + currentWishData.s + ' vous souhaite un Joyeux No√´l ! D√©couvrez votre message personnalis√©.';
    } else {
        shareText = 'üéÑ ' + currentWishData.s + ' melia ≈ãu na w√≤ be Kristmas y…î…îd…î! Kp…î wo∆íe nya si woa…ñe …ñe edzi.';
    }
    
    var facebookUrl = 'https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(shareUrl) + '&quote=' + encodeURIComponent(shareText);
    window.open(facebookUrl, '_blank', 'width=600,height=400');
}

function shareOnTwitter(e) {
    e.preventDefault();
    
    if (!currentWishData) {
        alert(currentLang === 'fr' 
            ? "Veuillez d'abord cr√©er un v≈ìu."
            : "Taflatse ∆âe dzidz…îkp…îkp…î …ñeka ∆íe edzi va …ño.");
        return;
    }
    
    var shareUrl = getWishShareUrl();
    var shareText = '';
    
    if (currentLang === 'fr') {
        shareText = 'üéÑ ' + currentWishData.s + ' vous envoie des v≈ìux de No√´l personnalis√©s ! #No√´l #V≈ìux';
    } else {
        shareText = 'üéÑ ' + currentWishData.s + ' ∆íoe dzidz…îkp…îkp…î ∆íe Kristmas si woa…ñe …ñe edzi na w√≤! #Kristmas';
    }
    
    var twitterUrl = 'https://twitter.com/intent/tweet?text=' + encodeURIComponent(shareText) + '&url=' + encodeURIComponent(shareUrl);
    window.open(twitterUrl, '_blank', 'width=600,height=400');
}

function shareOnWhatsApp(e) {
    e.preventDefault();
    
    if (!currentWishData) {
        alert(currentLang === 'fr' 
            ? "Veuillez d'abord cr√©er un v≈ìu."
            : "Taflatse ∆âe dzidz…îkp…îkp…î …ñeka ∆íe edzi va …ño.");
        return;
    }
    
    var shareUrl = getWishShareUrl();
    var message = '';
    
    if (currentLang === 'fr') {
        message = 'üéÑ ' + currentWishData.s + ' vous souhaite un Joyeux No√´l !\n\nD√©couvrez votre message personnalis√© ici :\n' + shareUrl + '\n\nVous pourrez entrer votre pr√©nom pour voir le message personnalis√©.\n\nContact WhatsApp : +228 96 17 39 53';
    } else {
        message = 'üéÑ ' + currentWishData.s + ' melia ≈ãu na w√≤ be Kristmas y…î…îd…î!\n\nKp…î wo∆íe nya si woa…ñe …ñe edzi le afisia:\n' + shareUrl + '\n\nAte≈ãu w√≤a∆ío wo∆íe ≈ãk…î …ñe eme ne w√≤adi be w√≤akp…î nya si woa…ñe …ñe edzi.\n\nWhatsApp ∆íe d…îw…î∆íua : +228 96 17 39 53';
    }
    
    var whatsappUrl = 'https://wa.me/?text=' + encodeURIComponent(message);
    window.open(whatsappUrl, '_blank');
}

// ============================================
// R√âINITIALISATION DU FORMULAIRE
// ============================================
function resetForm() {
    senderNameInput.value = "";
    wishTypeSelect.value = "custom";
    customWishTextarea.value = "";
    recipientNameInput.value = "";
    selectedPredefinedWishIndex = 0;
    if (predefinedWishes && predefinedWishes.length > 0) {
        selectedWish = predefinedWishes[0].content;
    }
    currentWishData = null;
    
    // R√©initialiser la s√©lection des v≈ìux pr√©d√©finis
    var wishOptions = document.querySelectorAll('.wish-option');
    for (var i = 0; i < wishOptions.length; i++) {
        wishOptions[i].classList.remove('selected');
        if (i === 0) {
            wishOptions[i].classList.add('selected');
        }
    }
    
    updateWishTypeDisplay();
    goToStep1();
}